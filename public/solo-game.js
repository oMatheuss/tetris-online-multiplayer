window.addEventListener("load",function(){canvasH=screen.width>screen.height?screen.height-.25*screen.height:screen.width-.25*screen.width;var h=window.Q=Quintus({development:!0}).include("Sprites, Scenes, Input, 2D, Touch, UI").setup({width:screen.width,height:screen.height-.25*screen.height,maximaze:"touch",scaleToFit:!0}).touch();h.input.touchControls({controls:[["left","←"],["down","↓"],["right","→"],[],["action","⥁"],["fire","↓↓"]]});function s(i,e){return i=Math.ceil(i),e=Math.floor(e),Math.floor(Math.random()*(e-i+1))+i}h.input.keyboardControls(),h.ctx.canvas.style.backgroundColor="rgb(222, 226, 230, 1)",h.gravityX=0,h.gravityY=0,gridScreenSize={w:canvasH/2,h:canvasH},gridSize={w:10,h:20},pieceSize={w:gridScreenSize.w/gridSize.w,h:gridScreenSize.h/gridSize.h},h.Sprite.extend("Grid",{init:function(i){this._super({color:"rgb(3, 4, 94)",x:i.x,y:i.y,w:gridScreenSize.w,h:gridScreenSize.h})},draw:function(e){var t={x:-this.p.cx,y:this.p.cy};let s=this.p.w,r=this.p.h;e.strokeStyle=this.p.color,e.lineWidth=1,e.beginPath();for(let i=0;i<=gridSize.h;i++)e.moveTo(t.x,t.y-i*pieceSize.h),e.lineTo(t.x+s,t.y-i*pieceSize.h);for(let i=0;i<=gridSize.w;i++)e.moveTo(t.x+i*pieceSize.w,t.y),e.lineTo(t.x+i*pieceSize.w,t.y-r);e.stroke()}}),h.Sprite.extend("Piece",{init:function(i,e,t,s){this._super({w:pieceSize.w,h:pieceSize.h}),this.x=0,this.y=0,this.gridPos=i,this.setPos(e,t),this.drawPoints=[1-this.p.cx,1-this.p.cy,this.p.w-2,this.p.h-2],this.color=s,this.setColors(s)},setColors:function(i){switch(i){case 1:this.p.color="rgb(220, 20, 60, 1)",this.borderColor="rgb(139,0,0)";break;case 2:this.p.color="rgb(255, 140, 0, 1)",this.borderColor="rgb(255,69,0)";break;case 3:this.p.color="rgb(106, 153, 78, 1)",this.borderColor="rgb(56, 102, 65)";break;case 4:this.p.color="rgb(90, 24, 154, 1)",this.borderColor="rgb(60, 9, 108)";break;case 5:this.p.color="rgb(3, 83, 164, 1)",this.borderColor="rgb(2, 62, 125)";break;case 6:this.p.color="rgb(255, 71, 126, 1)",this.borderColor="rgb(255, 10, 84)";break;case 7:this.p.color="rgb(114, 81, 181, 1)",this.borderColor="rgb(98, 71, 170)";break;default:this.p.color="red",this.borderColor="red"}},setPos:function(i,e){this.x=i,this.y=e,this.p.x=this.gridPos.x-gridScreenSize.w/2+pieceSize.w/2+i*pieceSize.w,this.p.y=this.gridPos.y+gridScreenSize.h/2-pieceSize.h/2-e*pieceSize.h},down:function(){--this.y,this.p.y+=pieceSize.h},left:function(){--this.x,this.p.x-=pieceSize.w},right:function(){this.x+=1,this.p.x+=pieceSize.w},draw:function(i){i.fillStyle=this.p.color,i.fillRect(this.drawPoints[0],this.drawPoints[1],this.drawPoints[2],this.drawPoints[3]),i.lineWidth=1,i.strokeStyle=this.borderColor,i.strokeRect(this.drawPoints[0],this.drawPoints[1],this.drawPoints[2],this.drawPoints[3])}}),h.Sprite.extend("Brick",{init:function(i,e,t,s){this._super({}),this.stage=i,this.gridPos=e,this.gameArray=t,this.pieces=new Array(4),this.createBrick(s)},createBrick:function(i){1==i?(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,5,21,1)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,4,21,1)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,5,20,1)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,4,20,1)),this.pivot={x:4.5,y:20.5}):2==i?(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,3,21,2)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,3,20,2)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,4,20,2)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,5,20,2)),this.pivot={x:4,y:20}):3==i?(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,3,20,3)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,4,20,3)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,5,20,3)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,5,21,3)),this.pivot={x:4,y:20}):4==i?(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,3,21,4)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,4,21,4)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,5,21,4)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,6,21,4)),this.pivot={x:4.5,y:20.5}):5==i?(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,3,20,5)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,4,20,5)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,5,20,5)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,4,21,5)),this.pivot={x:4,y:20}):6==i?(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,3,20,6)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,4,20,6)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,4,21,6)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,5,21,6)),this.pivot={x:4,y:20}):7==i&&(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,3,21,7)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,4,21,7)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,4,20,7)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,5,20,7)),this.pivot={x:4,y:20})},downTime:1,elapsed:0,moveDown:function(i){if(this.elapsed+=i,this.elapsed>=this.downTime){for(let i=0;i<4;i++){if(0==this.pieces[i].y)return-1;if(this.pieces[i].y-1<20&&this.gameArray[this.pieces[i].x][this.pieces[i].y-1].exist)return-1}for(let i=0;i<4;i++)this.pieces[i].down();return--this.pivot.y,this.elapsed=0,1}return 0},elapsedRL:0,moveLeft:function(){if(.1<this.elapsedRL){for(let i=0;i<4;i++){if(0==this.pieces[i].x)return!1;if(this.pieces[i].y<20&&this.gameArray[this.pieces[i].x-1][this.pieces[i].y].exist)return!1}for(let i=0;i<4;i++)this.pieces[i].left();return--this.pivot.x,!(this.elapsedRL=0)}return!1},moveRight:function(){if(.1<this.elapsedRL){for(let i=0;i<4;i++){if(9==this.pieces[i].x)return!1;if(this.pieces[i].y<20&&this.gameArray[this.pieces[i].x+1][this.pieces[i].y].exist)return!1}for(let i=0;i<4;i++)this.pieces[i].right();return this.pivot.x+=1,!(this.elapsedRL=0)}return!1},rotate:function(){for(let i=0;i<4;i++){var e=this.pivot.x+this.pivot.y-this.pieces[i].y,t=this.pivot.y-this.pivot.x+this.pieces[i].x;if(e<0||9<e||t<0)return!1;if(t<20&&this.gameArray[e][t].exist)return!1}for(let i=0;i<4;i++)this.pieces[i].setPos(this.pivot.x+this.pivot.y-this.pieces[i].y,this.pivot.y-this.pivot.x+this.pieces[i].x);return!0},saveOnGameArray:function(){let e=!0;for(let i=0;i<4;i++)0<=this.pieces[i].x&&this.pieces[i].x<=9&&(0<=this.pieces[i].y&&this.pieces[i].y<=19?(this.gameArray[this.pieces[i].x][this.pieces[i].y].exist=!0,this.gameArray[this.pieces[i].x][this.pieces[i].y].piece=this.pieces[i]):e=!1);return e},step:function(i){this.elapsedRL+=i}}),h.Sprite.extend("BrickStatic",{init:function(i,e,t){this._super({}),this.gridPos=e,this.stage=i,this.type=t,this.pieces=new Array(4),this.createBrick(t)},createBrick:function(i){1==i?(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,1,19,1)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,0,19,1)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,1,18,1)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,0,18,1))):2==i?(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,0,19,2)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,0,18,2)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,1,18,2)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,2,18,2))):3==i?(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,0,18,3)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,1,18,3)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,2,18,3)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,2,19,3))):4==i?(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,0,19,4)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,1,19,4)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,2,19,4)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,3,19,4))):5==i?(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,0,18,5)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,1,18,5)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,2,18,5)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,1,19,5))):6==i?(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,0,18,6)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,1,18,6)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,1,19,6)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,2,19,6))):7==i&&(this.pieces[0]=this.stage.insert(new h.Piece(this.gridPos,0,19,7)),this.pieces[1]=this.stage.insert(new h.Piece(this.gridPos,1,19,7)),this.pieces[2]=this.stage.insert(new h.Piece(this.gridPos,1,18,7)),this.pieces[3]=this.stage.insert(new h.Piece(this.gridPos,2,18,7)))},_destroy(){for(let i=0;i<4;i++)this.pieces[i].destroy()},moveDown:function(){for(let e=0;e<4;e++)for(let i=0;i<3;i++)this.pieces[e].down()}}),h.Sprite.extend("BrickGen",{init:function(i,e){this._super({}),this.gridPos={x:e.x+gridScreenSize.w+10,y:e.y},this.stage=i,this.bricks=new Array(3),this.gen()},gen:function(){for(let i=0;i<3;i++){var e=s(1,7);this.bricks[i]={brick:void 0,type:e}}for(let e=0;e<3;e++){this.bricks[e].brick=this.stage.insert(new h.BrickStatic(this.stage,this.gridPos,this.bricks[e].type));for(let i=0;i<2-e;i++)this.bricks[e].brick.moveDown()}},nextBrick:function(){var i=this.bricks[0].type;this.bricks[0].brick._destroy(),this.bricks[0].brick.destroy();for(let i=0;i<2;i++){var e=i+1;this.bricks[e].brick.moveDown(),this.bricks[i].brick=this.bricks[e].brick,this.bricks[i].type=this.bricks[e].type}var t=s(1,7);return this.bricks[2].brick=this.stage.insert(new h.BrickStatic(this.stage,this.gridPos,t)),this.bricks[2].type=t,i}}),h.Sprite.extend("Controller",{init:function(i,e,t,s){this._super({}),this.stage=i,this.gridPos=e,i.insert(new h.Grid(e)),this.brickGen=i.insert(new h.BrickGen(i,e)),this.gameArray=this.createNewGame(),this.score=t,this.callback=s,this.wasClickedDwn=!1,this.wasClickedRot=!1,this.wasClickedHd=!1,this.blockCounter=1.5,this.blockDwn=!1,this.createNewBrick(),this.lost=!1},createNewGame:function(){var t=new Array(gridSize.w);for(let e=0;e<gridSize.w;e++){t[e]=new Array(gridSize.h);for(let i=0;i<gridSize.h;i++)t[e][i]={exist:!1,piece:void 0}}return t},createNewBrick:function(){var i=this.brickGen.nextBrick();this.actualBrick=this.stage.insert(new h.Brick(this.stage,this.gridPos,this.gameArray,i))},attGameArray:function(){let i=0;for(let t=0;t<gridSize.h;t++){let e=!0;for(let i=0;i<gridSize.w;i++)if(!this.gameArray[i][t].exist){e=!1;break}if(e){i++;for(let i=0;i<gridSize.w;i++)this.gameArray[i][t].exist=!1,this.gameArray[i][t].piece.destroy();for(let e=t;e<gridSize.h-1;e++)for(let i=0;i<gridSize.w;i++)this.gameArray[i][e+1].exist&&(this.gameArray[i][e+1].exist=!1,this.gameArray[i][e+1].piece.down(),this.gameArray[i][e].exist=!0,this.gameArray[i][e].piece=this.gameArray[i][e+1].piece,this.gameArray[i][e+1].piece=null);t--}}0!=i&&(this.score.s+=200*i-100)},step:function(i){if(!this.lost){h.inputs.left&&this.actualBrick.moveLeft(),h.inputs.right&&this.actualBrick.moveRight(),h.inputs.action&&!this.wasClickedRot?(this.wasClickedRot=!0,this.actualBrick.rotate()):!h.inputs.action&&this.wasClickedRot&&(this.wasClickedRot=!1);var e=this.actualBrick.moveDown(i);if(h.inputs.fire&&!this.wasClickedHd){for(this.wasClickedHd=!0;-1!=this.actualBrick.moveDown(10);)this.score.s+=2;moveDown=-1,this.blockCounter=0}else!h.inputs.fire&&this.wasClickedHd&&(this.wasClickedHd=!1);-1==e?(0<this.blockCounter&&(this.blockCounter-=i,this.blockDwn=!0),this.blockCounter<=0&&(this.blockDwn=!1,this.actualBrick.saveOnGameArray()?(this.actualBrick.destroy(),this.attGameArray(),this.createNewBrick()):(this.actualBrick.destroy(),this.lost=!0,this.callback()),this.blockCounter=1.5)):1==e&&.05==this.actualBrick.downTime&&(this.score.s+=1),h.inputs.down&&!this.wasClickedDwn?(this.wasClickedDwn=!0,this.actualBrick.downTime=.05,this.blockDwn&&(this.blockCounter=0,this.wasClickedDwn=!1)):!h.inputs.down&&this.wasClickedDwn&&(this.wasClickedDwn=!1,this.actualBrick.downTime=1)}}}),h.scene("level1",function(s){var i={s:0},r={x:0,y:0},e=(s.insert(new h.Controller(s,r,i,()=>{var i=s.insert(new h.UI.Container({x:r.x,y:r.y,fill:"rgba(255,255,255,0.5)"})),e=i.insert(new h.UI.Button({x:0,y:0,fill:"#CCCCCC",label:"Voltar"})),t=i.insert(new h.UI.Button({x:0,y:-10-e.p.h,fill:"#CCCCCC",label:"Jogar de Novo"}));i.insert(new h.UI.Text({x:10,y:-20-t.p.h-e.p.h,label:"Finalizado!"}));t.on("click",()=>{h.clearStages(),h.stageScene("level1")}),e.on("click",()=>{window.location.href="/"}),i.fit(20)})),s.insert(new h.UI.Text({x:r.x,y:gridScreenSize.h/2+30,label:"Score: "+i.s})));s.add("viewport"),s.viewport.scale=.8,s.centerOn(0,0),s.on("step",()=>{e.p.label="Score "+i.s})}),h.scene("startGame",function(i){var i=i.insert(new h.UI.Container({x:h.width/2,y:h.height/2,w:280,h:150,fill:"rgba(255,255,255,0.5)"})),e=i.insert(new h.UI.Button({x:0,y:0,fill:"#CCCCCC",label:"Jogar"}));i.insert(new h.UI.Text({x:0,y:-e.p.h,label:"TETRIS"}));e.on("click",function(){h.clearStages(),h.stageScene("level1")}),i.fit(20)}),h.stageScene("startGame")});